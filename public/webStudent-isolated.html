<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="JournalHood Student App - Isolated">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
  
  <title>JournalHood Student</title>
  
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    p {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üìö</div>
    <h1>JournalHood Student</h1>
    <p>Loading your private journal app...</p>
    
    <div id="status" class="status info">
      <div class="loading"></div>
      Preparing isolated environment...
    </div>
    
    <button id="manualBtn" class="btn" style="display: none;" onclick="loadStudentApp()">
      Continue to Student App
    </button>
  </div>

  <script>
    console.log('üîê Starting complete authentication isolation for student app');
    
    let isolationComplete = false;
    
    function updateStatus(message, type = 'info') {
      const status = document.getElementById('status');
      const manualBtn = document.getElementById('manualBtn');
      
      if (type === 'success') {
        status.className = 'status success';
        status.innerHTML = `‚úÖ ${message}`;
        manualBtn.style.display = 'block';
      } else {
        status.className = 'status info';
        status.innerHTML = `<div class="loading"></div> ${message}`;
      }
    }
    
    // Step 1: Clear all possible authentication data
    function clearAllAuthData() {
      return new Promise((resolve) => {
        updateStatus('Clearing authentication cookies...');
        
        // Clear all possible auth cookies with every possible combination
        const authCookies = [
          'auth-token',
          'firebase-auth-session',
          'firebase-auth-user',
          '__session',
          'firebase-heartbeat-database',
          'firebase-heartbeat-store',
          'firebase-auth-current-user',
          'firebase-auth-persistence',
          'fbase_key'
        ];
        
        const domains = [
          window.location.hostname,
          `.${window.location.hostname}`,
          'localhost',
          '.localhost'
        ];
        
        const paths = ['/', '/webStudent/', '/webStudent', ''];
        
        authCookies.forEach(cookieName => {
          paths.forEach(path => {
            domains.forEach(domain => {
              document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=${path}; domain=${domain};`;
              document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=${path};`;
            });
          });
        });
        
        setTimeout(resolve, 500);
      });
    }
    
    // Step 2: Clear all storage
    function clearAllStorage() {
      return new Promise((resolve) => {
        updateStatus('Clearing local storage...');
        
        try {
          // Clear all localStorage
          localStorage.clear();
          
          // Clear all sessionStorage  
          sessionStorage.clear();
          
          console.log('‚úÖ Cleared all storage');
        } catch (e) {
          console.warn('Failed to clear storage:', e);
        }
        
        setTimeout(resolve, 500);
      });
    }
    
    // Step 3: Clear IndexedDB
    function clearAllIndexedDB() {
      return new Promise((resolve) => {
        updateStatus('Clearing database cache...');
        
        try {
          const dbNames = [
            'firebase-heartbeat-database',
            'firebase-installations-database', 
            'fcm_token_details_db',
            'firebaseLocalStorageDb'
          ];
          
          let completed = 0;
          const total = dbNames.length;
          
          if (total === 0) {
            resolve();
            return;
          }
          
          dbNames.forEach(dbName => {
            const deleteReq = indexedDB.deleteDatabase(dbName);
            deleteReq.onsuccess = deleteReq.onerror = () => {
              completed++;
              if (completed === total) {
                resolve();
              }
            };
          });
          
          // Fallback timeout
          setTimeout(resolve, 2000);
        } catch (e) {
          console.warn('Failed to clear IndexedDB:', e);
          setTimeout(resolve, 500);
        }
      });
    }
    
    // Step 4: Clear browser cache for this origin
    function clearBrowserCache() {
      return new Promise((resolve) => {
        updateStatus('Clearing browser cache...');
        
        // Use Cache API if available
        if ('caches' in window) {
          caches.keys().then(names => {
            return Promise.all(
              names.map(name => {
                if (name.includes('firebase') || name.includes('auth')) {
                  return caches.delete(name);
                }
              })
            );
          }).then(() => {
            console.log('‚úÖ Cleared cache storage');
            setTimeout(resolve, 500);
          }).catch(() => {
            setTimeout(resolve, 500);
          });
        } else {
          setTimeout(resolve, 500);
        }
      });
    }
    
    // Step 5: Load student app in isolated context
    function loadStudentApp() {
      updateStatus('Launching student app...');
      
      // Create isolated iframe or redirect to actual student app
      setTimeout(() => {
        // Open in same window but with timestamp to break cache
        const timestamp = Date.now();
        window.location.replace(`/webStudent/index.html?isolated=${timestamp}&t=${timestamp}`);
      }, 1000);
    }
    
    // Execute isolation sequence
    async function performIsolation() {
      try {
        await clearAllAuthData();
        await clearAllStorage();
        await clearAllIndexedDB();
        await clearBrowserCache();
        
        updateStatus('Environment isolated successfully!', 'success');
        isolationComplete = true;
        
        // Auto-proceed after 2 seconds
        setTimeout(() => {
          if (isolationComplete) {
            loadStudentApp();
          }
        }, 2000);
        
      } catch (error) {
        console.error('Isolation failed:', error);
        updateStatus('Isolation complete (with warnings)', 'success');
        isolationComplete = true;
      }
    }
    
    // Start isolation process
    window.addEventListener('load', () => {
      setTimeout(performIsolation, 100);
    });
    
    // Fallback: start immediately if load event already fired
    if (document.readyState === 'complete') {
      setTimeout(performIsolation, 100);
    }
  </script>
</body>
</html> 